name: Sync Fork with Upstream

on:
  # è®¡åˆ’ä»»åŠ¡ - æ¯å¤©UTCæ—¶é—´00:00åŒæ­¥ï¼ˆåŒ—äº¬æ—¶é—´08:00ï¼‰
  schedule:
    - cron: '0 0 * * *'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # æŽ¨é€è§¦å‘ï¼ˆå¯é€‰ï¼Œå½“æœ‰pushåˆ°masteråˆ†æ”¯æ—¶ä¹ŸåŒæ­¥ï¼‰
  push:
    branches:
      - master

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥æŽ¨é€æ›´æ”¹
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # èŽ·å–æ‰€æœ‰åŽ†å²è®°å½•ï¼Œä¾¿äºŽåˆå¹¶
          ref: master     # æŒ‡å®šåˆ†æ”¯ä¸ºmaster

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git config pull.rebase false  # ä½¿ç”¨mergeè€Œä¸æ˜¯rebase

      - name: Add upstream repository
        run: |
          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨upstreamè¿œç¨‹
          if ! git remote | grep -q upstream; then
            git remote add upstream https://github.com/LmeSzinc/AzurLaneAutoScript.git
          fi
          
          # æ˜¾ç¤ºè¿œç¨‹ä»“åº“ä¿¡æ¯
          git remote -v

      - name: Fetch upstream changes
        run: |
          git fetch upstream master  # èŽ·å–ä¸Šæ¸¸çš„masteråˆ†æ”¯

      - name: Check if merge is needed
        id: check
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æäº¤
          git log HEAD..upstream/master --oneline > commits.txt
          if [ -s commits.txt ]; then
            echo "æœ‰æ–°çš„æäº¤éœ€è¦åŒæ­¥"
            echo "new_commits=true" >> $GITHUB_OUTPUT
            echo "commit_count=$(wc -l < commits.txt)" >> $GITHUB_OUTPUT
            echo "commits=$(cat commits.txt | head -5 | tr '\n' '; ')" >> $GITHUB_OUTPUT
            cat commits.txt
          else
            echo "æ²¡æœ‰æ–°çš„æäº¤"
            echo "new_commits=false" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream changes
        if: steps.check.outputs.new_commits == 'true'
        id: merge
        run: |
          # è®¾ç½®å†²çªæ ‡å¿—ä¸ºfalse
          echo "CONFLICT_DETECTED=false" >> $GITHUB_ENV
          
          # å°è¯•åˆå¹¶
          if git merge upstream/master --no-edit; then
            echo "âœ… åˆå¹¶æˆåŠŸï¼Œæ— å†²çª"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
            if ! git diff --cached --quiet || ! git diff --quiet; then
              echo "æœ‰æ›´æ”¹éœ€è¦æäº¤"
              git add .
              git commit -m "è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸æ›´æ–°: $(date '+%Y-%m-%d %H:%M:%S')
              
              ä¸Šæ¸¸æäº¤:
              $(git log HEAD..upstream/master@{1} --oneline | head -10 | sed 's/^/  â€¢ /')"
            fi
          else
            # åˆå¹¶å¤±è´¥ï¼Œæ£€æµ‹åˆ°å†²çª
            echo "âŒ æ£€æµ‹åˆ°å†²çªï¼Œåˆå¹¶å¤±è´¥"
            echo "CONFLICT_DETECTED=true" >> $GITHUB_ENV
            
            # èŽ·å–å†²çªæ–‡ä»¶åˆ—è¡¨
            conflict_files=$(git diff --name-only --diff-filter=U)
            echo "å†²çªæ–‡ä»¶åˆ—è¡¨:" > conflict_files.txt
            echo "$conflict_files" >> conflict_files.txt
            
            # å–æ¶ˆåˆå¹¶
            git merge --abort
          fi

      - name: Send conflict notification
        if: steps.check.outputs.new_commits == 'true' && env.CONFLICT_DETECTED == 'true'
        run: |
          # è¯»å–å†²çªæ–‡ä»¶ä¿¡æ¯
          conflict_list=$(cat conflict_files.txt)
          
          # æž„å»ºé€šçŸ¥æ¶ˆæ¯
          message="ðŸš¨ GitHub åŒæ­¥å†²çª"
          body="ä»“åº“: ${{ github.repository }}
å†²çªæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
ä¸Šæ¸¸æäº¤æ•°: ${{ steps.check.outputs.commit_count }}
å†²çªæ–‡ä»¶æ•°: $(echo "$conflict_list" | wc -w)

éœ€è¦æ‰‹åŠ¨è§£å†³å†²çªï¼
è¯·è®¿é—®: https://github.com/${{ github.repository }}/actions"
          
          # å‘é€Barké€šçŸ¥
          curl -s \
            -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "body": "'"${body}"'",
              "title": "'"${message}"'",
              "group": "github",
              "url": "https://github.com/${{ github.repository }}/actions"
            }' \
            "https://api.day.app/N7xUCURtR3EWhsotV8oAUD/"
          
          echo "å·²å‘é€å†²çªé€šçŸ¥"

      - name: Push successful merge
        if: steps.check.outputs.new_commits == 'true' && env.CONFLICT_DETECTED == 'false'
        run: |
          # æŽ¨é€åˆ°ä½ çš„ä»“åº“
          git push origin master
          
          # åˆ›å»ºæˆåŠŸåŒæ­¥çš„æ‘˜è¦
          echo "## âœ… åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "å·²æˆåŠŸåŒæ­¥ä¸Šæ¸¸æ›´æ–°åˆ°ä½ çš„ä»“åº“" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š åŒæ­¥äº† ${{ steps.check.outputs.commit_count }} ä¸ªæäº¤" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ æœ€è¿‘çš„æäº¤ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.check.outputs.commits }}" | sed 's/; /\n- /g' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

      - name: Create summary for conflicts
        if: steps.check.outputs.new_commits == 'true' && env.CONFLICT_DETECTED == 'true'
        run: |
          # åˆ›å»ºå†²çªæ‘˜è¦
          echo "## ðŸš¨ åŒæ­¥å¤±è´¥ - æ£€æµ‹åˆ°å†²çª" >> $GITHUB_STEP_SUMMARY
          echo "åŒæ­¥è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°å†²çªï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š å°è¯•åŒæ­¥ ${{ steps.check.outputs.commit_count }} ä¸ªæäº¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å†²çªæ–‡ä»¶ï¼š" >> $GITHUB_STEP_SUMMARY
          cat conflict_files.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### è§£å†³æ–¹æ³•ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "1. å…‹éš†ä»“åº“åˆ°æœ¬åœ°" >> $GITHUB_STEP_SUMMARY
          echo "2. æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š" >> $GITHUB_STEP_SUMMARY
          echo '   ```bash' >> $GITHUB_STEP_SUMMARY
          echo '   git fetch upstream' >> $GITHUB_STEP_SUMMARY
          echo '   git merge upstream/master' >> $GITHUB_STEP_SUMMARY
          echo '   ```' >> $GITHUB_STEP_SUMMARY
          echo "3. æ‰‹åŠ¨è§£å†³å†²çª" >> $GITHUB_STEP_SUMMARY
          echo "4. æäº¤å¹¶æŽ¨é€åˆ°GitHub" >> $GITHUB_STEP_SUMMARY
