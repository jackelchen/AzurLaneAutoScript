name: Sync Fork with Upstream

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: master

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git config pull.rebase false

      - name: Add upstream repository
        run: |
          if ! git remote | grep -q upstream; then
            git remote add upstream https://github.com/LmeSzinc/AzurLaneAutoScript.git
          fi
          git remote -v

      - name: Fetch upstream changes
        run: |
          git fetch upstream master

      - name: Check if merge is needed
        id: check
        run: |
          git log HEAD..upstream/master --oneline > commits.txt
          if [ -s commits.txt ]; then
            echo "æœ‰æ–°çš„æäº¤éœ€è¦åŒæ­¥"
            echo "new_commits=true" >> $GITHUB_OUTPUT
            echo "commit_count=$(wc -l < commits.txt)" >> $GITHUB_OUTPUT
            echo "commits=$(cat commits.txt | head -5 | tr '\n' '; ')" >> $GITHUB_OUTPUT
            cat commits.txt
          else
            echo "æ²¡æœ‰æ–°çš„æäº¤"
            echo "new_commits=false" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream changes
        if: steps.check.outputs.new_commits == 'true'
        id: merge
        run: |
          echo "CONFLICT_DETECTED=false" >> $GITHUB_ENV
          
          if git merge upstream/master --no-edit; then
            echo "âœ… åˆå¹¶æˆåŠŸï¼Œæ— å†²çª"
            
            if ! git diff --cached --quiet || ! git diff --quiet; then
              echo "æœ‰æ›´æ”¹éœ€è¦æäº¤"
              git add .
              git commit -m "è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸æ›´æ–°: $(date '+%Y-%m-%d %H:%M:%S')
              
              ä¸Šæ¸¸æäº¤:
              $(git log HEAD..upstream/master@{1} --oneline | head -10 | sed 's/^/  â€¢ /')"
            fi
          else
            echo "âŒ æ£€æµ‹åˆ°å†²çªï¼Œåˆå¹¶å¤±è´¥"
            echo "CONFLICT_DETECTED=true" >> $GITHUB_ENV
            
            conflict_files=$(git diff --name-only --diff-filter=U)
            echo "å†²çªæ–‡ä»¶åˆ—è¡¨:" > conflict_files.txt
            echo "$conflict_files" >> conflict_files.txt
            
            git merge --abort
          fi

      - name: Send conflict notification
        if: steps.check.outputs.new_commits == 'true' && env.CONFLICT_DETECTED == 'true'
        run: |
          conflict_list=$(cat conflict_files.txt)
          
          # ä½¿ç”¨å•å¼•å·å’Œè½¬ä¹‰æž„å»º JSON
          curl -s \
            -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "body": "ä»“åº“: ${{ github.repository }}\nå†²çªæ—¶é—´: $(date +%Y-%m-%d\\ %H:%M:%S)\nä¸Šæ¸¸æäº¤æ•°: ${{ steps.check.outputs.commit_count }}\nå†²çªæ–‡ä»¶æ•°: $(echo \"$conflict_list\" | wc -w)\n\néœ€è¦æ‰‹åŠ¨è§£å†³å†²çªï¼\nè¯·è®¿é—®: https://github.com/${{ github.repository }}/actions",
              "title": "ðŸš¨ GitHub åŒæ­¥å†²çª",
              "group": "github",
              "url": "https://github.com/${{ github.repository }}/actions"
            }' \
            "https://api.day.app/N7xUCURtR3EWhsotV8oAUD/"
          
          echo "å·²å‘é€å†²çªé€šçŸ¥"

      - name: Push successful merge
        if: steps.check.outputs.new_commits == 'true' && env.CONFLICT_DETECTED == 'false'
        run: |
          git push origin master
          
          echo "## âœ… åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "å·²æˆåŠŸåŒæ­¥ä¸Šæ¸¸æ›´æ–°åˆ°ä½ çš„ä»“åº“" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š åŒæ­¥äº† ${{ steps.check.outputs.commit_count }} ä¸ªæäº¤" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ æœ€è¿‘çš„æäº¤ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.check.outputs.commits }}" | sed 's/; /\n- /g' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

      - name: Create summary for conflicts
        if: steps.check.outputs.new_commits == 'true' && env.CONFLICT_DETECTED == 'true'
        run: |
          echo "## ðŸš¨ åŒæ­¥å¤±è´¥ - æ£€æµ‹åˆ°å†²çª" >> $GITHUB_STEP_SUMMARY
          echo "åŒæ­¥è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°å†²çªï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š å°è¯•åŒæ­¥ ${{ steps.check.outputs.commit_count }} ä¸ªæäº¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å†²çªæ–‡ä»¶ï¼š" >> $GITHUB_STEP_SUMMARY
          cat conflict_files.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### è§£å†³æ–¹æ³•ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "1. å…‹éš†ä»“åº“åˆ°æœ¬åœ°" >> $GITHUB_STEP_SUMMARY
          echo "2. æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š" >> $GITHUB_STEP_SUMMARY
          echo '   ```bash' >> $GITHUB_STEP_SUMMARY
          echo '   git fetch upstream' >> $GITHUB_STEP_SUMMARY
          echo '   git merge upstream/master' >> $GITHUB_STEP_SUMMARY
          echo '   ```' >> $GITHUB_STEP_SUMMARY
          echo "3. æ‰‹åŠ¨è§£å†³å†²çª" >> $GITHUB_STEP_SUMMARY
          echo "4. æäº¤å¹¶æŽ¨é€åˆ°GitHub" >> $GITHUB_STEP_SUMMARY
